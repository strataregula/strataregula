# strataregula 開発ルール

## バージョニング規則

### 現在のバージョン
- **CURRENT_VERSION: 0.1.1**（pyproject.tomlと同期）

### 更新ルール
- PR作成時：0.1.x の x を +1
- 機能追加完了時：セマンティックバージョニングに従う
  - バグ修正：0.1.x+1
  - 機能追加：0.y+1.0
  - 破壊的変更：x+1.0.0（1.0.0未満は自由）

### 0.1.0リリース条件（達成済み）
- [x] CLI動作（sr compile）
- [x] パターン展開エンジン
- [x] 階層的地域サポート（47都道府県 → 8地域）
- [x] 複数出力フォーマット（Python/JSON/YAML）
- [x] メモリ効率ストリーミング処理
- [x] O(1)ルックアップ最適化
- [x] プロヴェナンス追跡

### 1.0.0リリース条件
- [ ] プラグインAPI v1動作確認
- [ ] カバレッジ90%以上
- [ ] パフォーマンステスト（10GB NDJSON）
- [ ] 完全な後方互換性
- [ ] 本番環境テスト

## 必須更新ファイル

PR作成時に必ず更新：
1. `pyproject.toml` - version フィールド（要作成）
2. `CHANGELOG.md` - Unreleased セクション
3. `strataregula/__init__.py` - __version__
4. このファイルの CURRENT_VERSION

## コミットメッセージ規則
```
<type>(<scope>): <subject>

<body>

Refs: SR-<issue_number>
Version: <new_version>
```

type: feat|fix|docs|style|refactor|test|chore|perf
scope: cli|core|pattern|hierarchy|template|stream|test|ci

## PR命名規則
`SR-<番号> | <機能名> | v<バージョン>`
例：`SR-1 | MVP v0.1.0 完成 | v0.1.0`

## ファイル構成規則
```
strataregula/
├── .development-rules.md     # このファイル
├── CHANGELOG.md              # 変更履歴
├── ROADMAP.md               # 最新ロードマップ
├── pyproject.toml           # バージョン定義（要作成）
├── setup.py                 # 現在の配布設定
├── strataregula/            # メインパッケージ
│   ├── __init__.py          # __version__定義
│   ├── cli/                 # CLI システム
│   │   ├── main.py         # エントリポイント
│   │   └── compile_command.py
│   ├── core/               # コアエンジン
│   │   ├── pattern_expander.py  # パターン展開
│   │   └── config_compiler.py   # 静的コンパイラ
│   ├── pipe/               # PiPE システム
│   ├── hooks/              # フックシステム
│   └── di/                 # 依存注入
├── examples/               # サンプル設定
├── tests/                  # テストスイート
└── docs/
    ├── adr/                # アーキテクチャ決定記録
    └── roadmap/            # 四半期別スナップショット
```

## アーキテクチャ方針

### 設計原則
1. **プラグイン拡張性**: すべてのコンポーネントはプラグイン可能
2. **メモリ効率**: ストリーミング処理で大規模データに対応
3. **型安全性**: TypeHint完備、mypy strict準拠
4. **テスト駆動**: 最小90%カバレッジ目標
5. **ゼロ設定**: 即座に利用可能なデフォルト設定

### 技術スタック
- **Python**: 3.11+ （型ヒント活用）
- **CLI**: click framework
- **出力**: rich library
- **設定**: YAML/JSON パース
- **テスト**: pytest + coverage
- **型チェック**: mypy strict
- **リント**: ruff

## 品質保証

### テスト要件
- **単体テスト**: 各モジュール90%カバレッジ
- **統合テスト**: CLI全コマンド動作確認
- **パフォーマンステスト**: 10GB NDJSON処理（≤200MB メモリ）
- **契約テスト**: 既存config_compiler.py互換性

### CI/CD要件
- **Python**: 3.11固定（クロスバージョン対応は1.0.0以降）
- **リント**: ruff check + format
- **型チェック**: mypy --strict
- **テスト**: pytest + coverage report
- **セキュリティ**: bandit scan

## 現在の実装状況（v0.1.0）

### 完成機能
- ✅ **パターン展開エンジン**: ワイルドカード → 47都道府県/8地域
- ✅ **CLI統合**: `sr compile` コマンド（config_compiler.py後方互換）
- ✅ **複数出力形式**: Python/JSON/YAML
- ✅ **階層ルックアップ**: 地域別・都道府県別検索
- ✅ **プロヴェナンス追跡**: 入力ファイル・フィンガープリント・パフォーマンス統計
- ✅ **ストリーミング処理**: メモリ制限・チャンクサイズ調整
- ✅ **O(1)最適化**: 静的マッピング生成

### 技術的成果
```
入力パターン: 13 patterns
展開結果: 179 services 
処理時間: <10ms
メモリ使用量: ~44MB
サポート階層: 47都道府県 → 8地域 → サービス
```

### 次期開発優先度
1. **pyproject.toml作成** - モダンな配布設定
2. **包括的テストスイート** - 現在の実装テスト
3. **パフォーマンステスト** - 10GB NDJSON要件
4. **CI/CD自動化** - GitHub Actions
5. **プラグインAPI設計** - 拡張可能アーキテクチャ