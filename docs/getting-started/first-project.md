# Your First Strataregula Project

This tutorial walks you through creating your first Strataregula project from scratch.

## Project Overview

We'll create a configuration system for a distributed web service with:
- Multiple service types (API, web frontend, cache)
- Japanese prefecture-based deployment
- Environment-specific configurations
- Automated pattern expansion

## Step 1: Project Setup

### Create Project Directory

```bash
mkdir my-strataregula-project
cd my-strataregula-project

# Create directory structure
mkdir -p config/{base,environments} output docs
```

### Initialize Configuration

Create `config/base/services.yaml`:
```yaml
# Base service configuration
services:
  api:
    - "api.*.service"
    - "api.*.health"
  
  web:
    - "web.*.frontend"
    - "web.*.static"
  
  cache:
    - "cache.*.redis"
    - "cache.*.memcached"

regions:
  kanto: ["tokyo", "chiba", "saitama", "kanagawa", "tochigi", "gunma", "ibaraki"]
  kansai: ["osaka", "kyoto", "hyogo", "nara", "wakayama", "shiga"]
  chubu: ["aichi", "shizuoka", "gifu", "mie", "nagano", "yamanashi", "niigata", "toyama", "ishikawa", "fukui"]
  kyushu: ["fukuoka", "saga", "nagasaki", "kumamoto", "oita", "miyazaki", "kagoshima", "okinawa"]
  tohoku: ["sendai", "aomori", "iwate", "akita", "yamagata", "fukushima"]
  chugoku: ["hiroshima", "okayama", "tottori", "shimane", "yamaguchi"]
  shikoku: ["tokushima", "kagawa", "ehime", "kochi"]
  hokkaido: ["hokkaido"]
```

## Step 2: Environment Configuration

### Development Environment

Create `config/environments/development.yaml`:
```yaml
# Development environment overrides
extends: ../base/services.yaml

services:
  api:
    - "api.dev.*.service"
    - "api.dev.*.debug"
  
  monitoring:
    - "monitor.dev.*.prometheus"
    - "monitor.dev.*.grafana"

resource_limits:
  cpu: "100m"
  memory: "128Mi"
  
replicas: 1
```

### Production Environment

Create `config/environments/production.yaml`:
```yaml
# Production environment configuration
extends: ../base/services.yaml

services:
  api:
    - "api.prod.*.service"
    - "api.prod.*.service-lb"
  
  web:
    - "web.prod.*.frontend"
    - "web.prod.*.frontend-cdn"
  
  monitoring:
    - "monitor.prod.*.prometheus"
    - "monitor.prod.*.alertmanager"
  
  security:
    - "security.prod.*.firewall"
    - "security.prod.*.waf"

resource_limits:
  cpu: "2000m"
  memory: "4Gi"
  
replicas: 3
```

## Step 3: Basic Compilation

### Compile Development Configuration

```bash
# Compile development environment
sr compile config/environments/development.yaml \
  --output output/development.py \
  --format python

# View results
head -20 output/development.py
```

Expected output:
```python
# Generated by Strataregula v0.1.1
# Source: config/environments/development.yaml
# Generated at: 2025-08-25T10:30:00+09:00

from typing import List, Dict, Optional

# Expanded services (248 total)
SERVICES = [
    "api.dev.tokyo.service",
    "api.dev.chiba.service",
    "api.dev.saitama.service",
    # ... (continues with all prefectures)
    "monitor.dev.hokkaido.grafana"
]

# Lookup functions
def get_services_by_region(region: str) -> List[str]:
    """Get all services for a specific region."""
    region_map = {
        "kanto": [s for s in SERVICES if any(p in s for p in ["tokyo", "chiba", "saitama", "kanagawa", "tochigi", "gunma", "ibaraki"])],
        # ... (other regions)
    }
    return region_map.get(region, [])
```

### Check Expansion Statistics

```bash
# Get detailed statistics
sr compile config/environments/development.yaml --stats

# Plan mode (no file generation)
sr compile config/environments/development.yaml --plan
```

Expected output:
```
📋 Compilation Plan
==================
Input: config/environments/development.yaml
Output format: python
Patterns to expand: 8
Expected services: ~376 services

Pattern Analysis:
✓ api.dev.*.service → 47 services (47 prefectures)
✓ api.dev.*.debug → 47 services (47 prefectures)
✓ web.dev.*.frontend → 47 services (47 prefectures)
✓ web.dev.*.static → 47 services (47 prefectures)
✓ cache.dev.*.redis → 47 services (47 prefectures)
✓ cache.dev.*.memcached → 47 services (47 prefectures)
✓ monitor.dev.*.prometheus → 47 services (47 prefectures)
✓ monitor.dev.*.grafana → 47 services (47 prefectures)

Memory estimate: ~25MB
Compilation time estimate: ~15ms
```

## Step 4: Multiple Output Formats

### Generate JSON Configuration

```bash
# JSON output for configuration management
sr compile config/environments/production.yaml \
  --output output/production.json \
  --format json
```

### Generate YAML Templates

```bash
# YAML output for Kubernetes
sr compile config/environments/production.yaml \
  --output output/production-k8s.yaml \
  --format yaml
```

### Examine JSON Output

```bash
# Pretty print JSON output
python -m json.tool output/production.json | head -30
```

Expected JSON structure:
```json
{
  "metadata": {
    "generated_by": "strataregula v0.1.1",
    "source_file": "config/environments/production.yaml",
    "timestamp": "2025-08-25T10:30:00+09:00",
    "format": "json"
  },
  "services": [
    "api.prod.tokyo.service",
    "api.prod.chiba.service",
    "web.prod.tokyo.frontend",
    "security.prod.tokyo.firewall"
  ],
  "patterns": {
    "api.prod.*.service": [
      "api.prod.tokyo.service",
      "api.prod.osaka.service"
    ]
  },
  "regions": {
    "kanto": {
      "prefectures": ["tokyo", "chiba", "saitama"],
      "services": ["api.prod.tokyo.service", "web.prod.tokyo.frontend"]
    }
  }
}
```

## Step 5: Using Generated Code

### Python Integration

Create `use_generated.py`:
```python
#!/usr/bin/env python3
"""Example usage of generated configuration."""

import sys
sys.path.append('output')

# Import generated configuration
from development import SERVICES, get_services_by_region

def main():
    print(f"📊 Total services: {len(SERVICES)}")
    
    # Get services by region
    kanto_services = get_services_by_region('kanto')
    print(f"🗾 Kanto region services: {len(kanto_services)}")
    
    # Find API services
    api_services = [s for s in SERVICES if 'api' in s]
    print(f"🔌 API services: {len(api_services)}")
    
    # Find monitoring services
    monitor_services = [s for s in SERVICES if 'monitor' in s]
    print(f"📈 Monitoring services: {len(monitor_services)}")
    
    # Show sample services
    print("\n📋 Sample services:")
    for service in SERVICES[:10]:
        print(f"  - {service}")
    
if __name__ == "__main__":
    main()
```

Run the example:
```bash
python use_generated.py
```

Expected output:
```
📊 Total services: 376
🗾 Kanto region services: 56
🔌 API services: 94
📈 Monitoring services: 94

📋 Sample services:
  - api.dev.tokyo.service
  - api.dev.chiba.service
  - api.dev.saitama.service
  - api.dev.kanagawa.service
  - api.dev.tochigi.service
  - api.dev.gunma.service
  - api.dev.ibaraki.service
  - api.dev.osaka.service
  - api.dev.kyoto.service
  - api.dev.hyogo.service
```

## Step 6: DOE Runner Integration

Now let's add performance testing with DOE Runner.

### Create Test Cases

Create `performance/test_cases.csv`:
```csv
case_id,backend,cmd_template,timeout_s,seed,retries,resource_group,expected_p95,threshold_p95
api-health-check,shell,"curl -s http://api.dev.tokyo.service:8080/health",10,42,2,light,0.05,0.08
api-load-test,shell,"wrk -t4 -c50 -d30s --latency http://api.dev.tokyo.service:8080/api/v1/users",45,123,1,medium,0.10,0.15
web-frontend-test,shell,"curl -s http://web.dev.tokyo.frontend:3000/",10,456,1,light,0.03,0.05
cache-redis-test,shell,"redis-cli -h cache.dev.tokyo.redis ping",5,789,1,light,0.01,0.02
monitor-prometheus-test,shell,"curl -s http://monitor.dev.tokyo.prometheus:9090/metrics | head -1",10,101,1,light,0.02,0.03
```

### Run Performance Tests

```bash
# Install DOE Runner if not already installed
pip install strataregula-doe-runner

# Execute test cases
srd run --cases performance/test_cases.csv \
       --out performance/results.csv \
       --max-workers 2 \
       --verbose
```

### Analyze Results

Create `analyze_performance.py`:
```python
#!/usr/bin/env python3
"""Analyze performance test results."""

import csv
import pandas as pd

def analyze_results():
    # Load results
    df = pd.read_csv('performance/results.csv')
    
    print("📊 Performance Test Results")
    print("=" * 40)
    print(f"Total tests: {len(df)}")
    print(f"Successful: {len(df[df['status'] == 'OK'])}")
    print(f"Failed: {len(df[df['status'] != 'OK'])}")
    
    # Analyze performance metrics
    successful = df[df['status'] == 'OK']
    if len(successful) > 0:
        print(f"\n📈 Performance Metrics:")
        print(f"Average P95: {successful['p95'].mean():.3f}s")
        print(f"Average throughput: {successful['throughput_rps'].mean():.0f} RPS")
        
        # Check threshold violations
        violations = successful[successful['p95'] > successful.get('threshold_p95', float('inf'))]
        if len(violations) > 0:
            print(f"\n⚠️  Threshold violations: {len(violations)}")
            for _, row in violations.iterrows():
                print(f"  - {row['case_id']}: {row['p95']}s > {row['threshold_p95']}s")
        else:
            print("\n✅ All thresholds met")
    
if __name__ == "__main__":
    analyze_results()
```

## Step 7: Automation Script

Create `build.sh`:
```bash
#!/bin/bash
# Build script for Strataregula project

set -e

echo "🏗️  Building Strataregula project..."

# Clean output directory
rm -rf output/*

# Compile all environments
echo "📄 Compiling configurations..."

# Development
sr compile config/environments/development.yaml \
   --output output/development.py \
   --format python \
   --enable-statistics

# Production  
sr compile config/environments/production.yaml \
   --output output/production.py \
   --format python \
   --enable-statistics

# Generate JSON for configuration management
sr compile config/environments/production.yaml \
   --output output/production.json \
   --format json

echo "✅ Configuration compilation completed"

# Run tests if DOE Runner is available
if command -v srd &> /dev/null; then
    echo "🧪 Running performance tests..."
    
    srd run --cases performance/test_cases.csv \
           --out performance/results.csv \
           --max-workers 2
    
    # Analyze results
    if [ -f "analyze_performance.py" ]; then
        python analyze_performance.py
    fi
    
    echo "✅ Performance tests completed"
else
    echo "⚠️  DOE Runner not installed, skipping performance tests"
fi

echo "🎉 Build completed successfully!"
```

Make it executable and run:
```bash
chmod +x build.sh
./build.sh
```

## Step 8: CI/CD Integration

### GitHub Actions Workflow

Create `.github/workflows/build.yml`:
```yaml
name: Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install strataregula strataregula-doe-runner
    
    - name: Compile configurations
      run: |
        sr compile config/environments/development.yaml --output output/development.py --stats
        sr compile config/environments/production.yaml --output output/production.json --format json
    
    - name: Run performance tests
      run: |
        srd run --cases performance/test_cases.csv --out performance/results.csv --dry-run
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: compiled-configs
        path: output/
```

## Step 9: Project Documentation

Create `README.md`:
```markdown
# My Strataregula Project

Distributed web service configuration management using Strataregula pattern expansion.

## Architecture

- **Services**: API, web frontend, cache, monitoring, security  
- **Regions**: 8 Japanese regions covering 47 prefectures
- **Environments**: Development, production
- **Total Services**: ~750 (376 dev + 376 prod)

## Quick Start

```bash
# Build all configurations
./build.sh

# Use generated configuration
python use_generated.py

# Run performance tests
srd run --cases performance/test_cases.csv --out performance/results.csv
```

## Structure

```
├── config/
│   ├── base/services.yaml          # Base service definitions
│   └── environments/
│       ├── development.yaml        # Dev environment
│       └── production.yaml         # Prod environment
├── output/                         # Generated configurations
├── performance/                    # Performance test cases
└── docs/                          # Documentation
```

## Generated Services

The configuration expands to services like:
- `api.prod.tokyo.service` - Tokyo API service (production)
- `web.dev.osaka.frontend` - Osaka web frontend (development)  
- `cache.prod.hokkaido.redis` - Hokkaido Redis cache (production)

## Performance Testing

Performance tests verify:
- API health endpoints
- Load testing capacity
- Frontend responsiveness
- Cache performance
- Monitoring availability
```

## Step 10: Advanced Features

### Custom Pattern Functions

Create `config/advanced/custom_patterns.yaml`:
```yaml
# Advanced pattern configuration with custom functions
services:
  api:
    # Priority-based deployment
    - "api.priority-{priority}.*.service"
    
  database:
    # Shard-based database deployment  
    - "db.shard-{shard:02d}.*.primary"
    - "db.shard-{shard:02d}.*.replica"

variables:
  priority: [1, 2, 3]  # High, medium, low priority
  shard: [1, 2, 3, 4, 5]  # 5 database shards
```

### Template Generation

Create `templates/kubernetes.yaml.j2`:
```yaml
# Kubernetes deployment template
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ service_name }}
  namespace: {{ environment }}
spec:
  replicas: {{ replicas }}
  selector:
    matchLabels:
      app: {{ service_name }}
  template:
    metadata:
      labels:
        app: {{ service_name }}
        region: {{ region }}
    spec:
      containers:
      - name: {{ service_name }}
        image: myregistry/{{ service_name }}:{{ version }}
        resources:
          limits:
            cpu: {{ resource_limits.cpu }}
            memory: {{ resource_limits.memory }}
```

## Congratulations! 🎉

You've successfully created your first Strataregula project with:

- ✅ Multi-environment configuration management
- ✅ Pattern-based service expansion (47 prefectures × 8 service types)
- ✅ Multiple output formats (Python, JSON, YAML)
- ✅ Performance testing integration with DOE Runner
- ✅ CI/CD automation
- ✅ Comprehensive documentation

## Next Steps

1. **[Core Concepts](../user-guide/concepts.md)** - Deeper understanding of Strataregula
2. **[Advanced Patterns](../tutorials/advanced-patterns.md)** - Complex pattern scenarios
3. **[Plugin Development](../tutorials/plugin-development-tutorial.md)** - Create custom plugins
4. **[Real World Examples](../examples/real-world.md)** - Production use cases

## Support

- **Documentation**: [Full Documentation](../index.md)
- **Examples**: [More Examples](../examples/getting-started.md)
- **Community**: [GitHub Discussions](https://github.com/strataregula/strataregula/discussions)