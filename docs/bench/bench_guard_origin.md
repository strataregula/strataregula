# Bench Guard Origin & Rules (Golden Metrics) - SSOT

**ç›®çš„**: ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®æœ€é€ŸçµŒè·¯ï¼ˆFastï¼‰ãŒå¸¸ã«åŸºæº–ï¼ˆSlowï¼‰ã‚ˆã‚Šååˆ†é€Ÿã„ã“ã¨ã‚’CIã§ä¿è¨¼ã—ã€æ€§èƒ½å›žå¸°ã‚’å³æ¤œçŸ¥ãƒ»å³é®æ–­

**ä½œæˆæ—¥**: 2025-08-31  
**æœ€çµ‚æ›´æ–°**: 2025-08-31  
**è²¬ä»»è€…**: Performance Team  
**SSOT**: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå”¯ä¸€ã®å‚ç…§ç‚¹

---

## ðŸ“‹ èµ·ç‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆä¿å­˜ç‰ˆï¼‰

### å…ƒæŒ‡ç¤º (2025-08-29)
```
## A. config_compiler ã® O(1) ç›´ãƒžãƒƒãƒ—åŒ–
- ä»•æ§˜:
  1) --traffic ã¨ --prefectures ã‚’èª­ã¿è¾¼ã¿ã€å…¨ãƒªã‚½ãƒ¼ã‚¹(base)ã‚’åˆ—æŒ™ã—ã¦ DIRECT_MAPPING ã‚’ç”Ÿæˆ
  2) ç”Ÿæˆç‰© src/compiled_config.py ã«ã¯ DIRECT_MAPPING: Dict[str, float]
  3) get_service_time(name:str)->float: 1) ç›´ãƒžãƒƒãƒ—å‚ç…§ â†’ 2) å½¹å‰²ãƒ™ãƒ¼ã‚¹fallback â†’ 3) 0.0

## C. ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯è¿½åŠ 
- æ–°è¦: scripts/bench_service_time.py
- 3ãƒ¢ãƒ¼ãƒ‰ï¼ˆfnmatch / compiled_tree / direct_mapï¼‰ã§ 1e5 å›ž lookup ã‚’ 3å›žãšã¤è¨ˆæ¸¬
- README ã«ã€Œç›®æ¨™: direct_map >= 50x fnmatchã€ã‚’æ˜Žè¨˜
```

### è¨­è¨ˆæ„å›³
- **Fastå®Ÿè£…**: O(1) ç›´ãƒžãƒƒãƒ—ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆäº‹å‰å±•é–‹è¾žæ›¸ï¼‰
- **Slowå®Ÿè£…**: O(nÃ—m) fnmatchãƒ‘ã‚¿ãƒ¼ãƒ³ç…§åˆï¼ˆæ—¢å­˜æ‰‹æ³•ï¼‰
- **ç›®æ¨™æ€§èƒ½**: **50å€é€ŸåŒ–** (direct_map/fnmatch â‰¥ 50x)

---

## ðŸŽ¯ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å®šç¾©

### APIå¢ƒç•Œ
```python
# scripts/config_compiler.py
def compile_traffic(traffic_path, prefectures_path) -> Dict[str, float]:
    """å…¨baseã‚’äº‹å‰å±•é–‹ã—DIRECT_MAPPINGã‚’ç”Ÿæˆ"""

# src/compiled_config.py (è‡ªå‹•ç”Ÿæˆ)
DIRECT_MAPPING: Dict[str, float] = {...}
def get_service_time(base: str) -> float:
    return DIRECT_MAPPING.get(base) or fallback_logic(base) or 0.0
```

### æ¯”è¼ƒè»¸
- **Fast**: `direct_map` - äº‹å‰å±•é–‹è¾žæ›¸ã®O(1)ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—
- **Slow**: `fnmatch` - ãƒ‘ã‚¿ãƒ¼ãƒ³ç…§åˆã®O(nÃ—m)å‡¦ç†
- **å¯¾è±¡**: ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ã¿ï¼ˆI/Oãƒ»YAMLèª­ã¿è¾¼ã¿é™¤å¤–ï¼‰

### æ¸¬å®šãƒ—ãƒ­ãƒˆã‚³ãƒ«
- **å®Ÿè¡Œ**: 100,000å›žÃ—3ã‚»ãƒƒãƒˆ
- **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**: avg/var/p95ã‚’JSONä¿å­˜
- **å‡ºåŠ›**: `.cache/bench_guard.json`

---

## ðŸ“Š CI ã‚¬ãƒ¼ãƒ‰åŸºæº–

### æ€§èƒ½é–¾å€¤
```yaml
# ãƒ¡ã‚¤ãƒ³åŸºæº–ï¼ˆmain branchï¼‰
direct_map/fnmatch >= 20x  # æœ€ä½ŽåŸºæº–
target: >= 50x             # ç›®æ¨™å€¤

# PRåŸºæº–ï¼ˆpull requestï¼‰  
direct_map/fnmatch >= 10x  # ç·©å’ŒåŸºæº–
```

### å®‰å®šæ€§åŸºæº–
```yaml
p95_direct_map <= 10ms     # 100kå®Ÿè¡Œã§ã®P95ä¸Šé™
variance_coefficient < 0.1  # å®Ÿè¡Œæ™‚é–“ã®å¤‰å‹•ä¿‚æ•°
```

### é‹ç”¨ç·©å’Œç­–
- **ãƒ©ãƒ™ãƒ«é‹ç”¨**:
  - `ci:bench-relaxed`: PRé™å®šã§é–¾å€¤ç·©å’Œ
  - `ci:bench-skip`: æœŸé™ä»˜ãã‚¹ã‚­ãƒƒãƒ—ï¼ˆ2å›žé€£ç¶šã§æ”¹å–„ã‚¿ã‚¹ã‚¯å¿…é ˆï¼‰

---

## ðŸ”§ å¤‰æ›´æ‰‹é †ãƒ»ã‚¬ãƒãƒŠãƒ³ã‚¹

### é–¾å€¤å¤‰æ›´ãƒ—ãƒ­ã‚»ã‚¹
1. **è¨ˆæ¸¬å®Ÿæ–½**: ç›´è¿‘3å›žã®ä¸­å¤®å€¤ã‚’å–å¾—
2. **æ ¹æ‹ è¨˜è¼‰**: ç’°å¢ƒãƒ»è¨ˆæ¸¬å€¤ãƒ»JSONãƒ‡ãƒ¼ã‚¿ã‚’æ·»ä»˜
3. **PRä½œæˆ**: ã“ã®SSoTãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ç†ç”±ã‚’è¨˜è¼‰
4. **ãƒ¬ãƒ“ãƒ¥ãƒ¼**: 2åä»¥ä¸Šã®æ‰¿èªå¿…é ˆ
5. **æ¤œè¨¼**: å›žå¸°ãƒ†ã‚¹ãƒˆ100%ãƒ‘ã‚¹ç¢ºèª
6. **æ–‡æ›¸åŒæœŸ**: READMEãƒ»CIè¨­å®šã®åŒæœŸæ›´æ–°

### æ‰¿èªè€…
- **ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰**: è¨­è¨ˆãƒ»ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ‰¿èª
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è²¬ä»»è€…**: é–¾å€¤ãƒ»åŸºæº–å€¤æ‰¿èª
- **ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼**: ç·Šæ€¥ã‚¹ã‚­ãƒƒãƒ—æ‰¿èª

### å®šæœŸè¦‹ç›´ã—
- **æœˆæ¬¡ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ç¬¬3é‡‘æ›œæ—¥ã«é–¾å€¤å¦¥å½“æ€§ç¢ºèª
- **å››åŠæœŸèª¿æ•´**: ãƒªãƒªãƒ¼ã‚¹å¾Œ2é€±é–“ä»¥å†…ã«ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°
- **ç·Šæ€¥è¦‹ç›´ã—**: é€£ç¶šå¤±æ•—3å›žã§å³åº§ãƒˆãƒªã‚¢ãƒ¼ã‚¸

---

## ðŸš¨ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»é€šçŸ¥

### è‡ªå‹•é€šçŸ¥
```yaml
CIå¤±æ•—: Slack #performance å³åº§é€šçŸ¥
é€£ç¶šå¤±æ•—: 2å›žç›®ã§ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³  
ç·Šæ€¥ã‚¹ã‚­ãƒƒãƒ—: å…¨é–‹ç™ºè€…ã«ç†ç”±ä»˜ãé€šçŸ¥
é€±æ¬¡ã‚µãƒžãƒª: é‡‘æ›œæ—¥ã«æˆåŠŸçŽ‡ãƒ»å‚¾å‘ãƒ¬ãƒãƒ¼ãƒˆ
```

### å“è³ªåŸºæº–
- **False Positiveè¨±å®¹çŽ‡**: <5% (æœˆé–“)
- **æ¤œå‡ºæ„Ÿåº¦**: 20%ä»¥ä¸Šã®æ€§èƒ½åŠ£åŒ–ã¯å¿…ãšæ¤œå‡º
- **å¾©æ—§æ™‚é–“**: CIéšœå®³ã‹ã‚‰å¾©æ—§ã¾ã§<2æ™‚é–“

---

## ðŸ“ˆ å±¥æ­´ãƒ»å¤‰æ›´ãƒ­ã‚°

### v1.0 (2025-08-31) - åˆæœŸè¨­å®š
- **mainåŸºæº–**: 20x (æœ€ä½Ž) / 50x (ç›®æ¨™)
- **PRåŸºæº–**: 10x (ç·©å’Œ)
- **æ ¹æ‹ **: å…ƒæŒ‡ç¤ºã®50å€é€ŸåŒ–è¦æ±‚
- **è¨ˆæ¸¬ç’°å¢ƒ**: GitHub Actions Ubuntu-latest Python 3.11

### å¤‰æ›´ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
```markdown
### v1.x (YYYY-MM-DD) - å¤‰æ›´ç†ç”±
- **å¤‰æ›´å†…å®¹**: é–¾å€¤ãƒ»åŸºæº–ãƒ»ãƒ—ãƒ­ã‚»ã‚¹ã®å¤‰æ›´
- **æ ¹æ‹ **: 3å›žè¨ˆæ¸¬ã®ä¸­å¤®å€¤ãƒ‡ãƒ¼ã‚¿
- **å½±éŸ¿ç¯„å›²**: CIãƒ»READMEãƒ»æ–‡æ›¸ã®åŒæœŸç®‡æ‰€
- **æ‰¿èªè€…**: [ãƒ†ãƒƒã‚¯ãƒªãƒ¼ãƒ‰å] + [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è²¬ä»»è€…å]
```

---

## ðŸ” å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ç·Šæ€¥å¾©æ—§ï¼ˆPhase 1ï¼‰
- [ ] `compile_traffic()` APIè¿½åŠ ã§bench_guard.pyä¿®æ­£
- [ ] CIé–¾å€¤ã‚’ main:20x / PR:10x ã«è¨­å®š
- [ ] ãƒ©ãƒ™ãƒ«é‹ç”¨(`ci:bench-relaxed`/`ci:bench-skip`)å°Žå…¥

### æ’ä¹…å¯¾å¿œï¼ˆPhase 2ï¼‰  
- [ ] å®Œå…¨ç›´ãƒžãƒƒãƒ—ç”Ÿæˆ(`src/compiled_config.py`)
- [ ] Engine Fast Pathå›ºå®šåŒ–
- [ ] ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é™å®šãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯

### æ•´å‚™å®Œäº†ï¼ˆPhase 3ï¼‰
- [ ] `.cache/bench_guard.json` CIã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆåŒ–
- [ ] READMEåŒæœŸ(æ¯”è¼ƒå¯¾è±¡ãƒ»ç›®æ¨™ãƒ»åŸºæº–æ˜Žè¨˜)
- [ ] SSOTæ›´æ–°ãƒ•ãƒ­ãƒ¼ã®ç¢ºç«‹

---

## ðŸ“ž é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

### ãƒ•ã‚¡ã‚¤ãƒ«
- **å®Ÿè£…**: `scripts/bench_guard.py`, `strataregula/core/config_compiler.py`
- **CI**: `.github/workflows/bench-guard.yml`, `golden-metrics.yml`  
- **æ–‡æ›¸**: `AGENTS.md`, `README.md`

### ã‚³ãƒžãƒ³ãƒ‰
```bash
# æ‰‹å‹•ãƒ™ãƒ³ãƒãƒžãƒ¼ã‚¯
python scripts/bench_service_time.py --json .cache/bench_guard.json

# é–¾å€¤ãƒ†ã‚¹ãƒˆ
python scripts/bench_guard_check.py --min-multiplier 20 --vs fnmatch --mode direct_map

# è¨­å®šèª¿æ•´
SR_BENCH_MIN_RATIO=10 python scripts/bench_guard.py
```

---

**é‡è¦**: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒ Golden Metrics Guard ã«é–¢ã™ã‚‹å”¯ä¸€ã®ä¿¡é ¼ã§ãã‚‹æƒ…å ±æº(SSOT)ã§ã™ã€‚å¤‰æ›´æ™‚ã¯å¿…ãšã“ã“ã‚’æ›´æ–°ã—ã€é–¢é€£æ–‡æ›¸ã¨ã®åŒæœŸã‚’ç¢ºä¿ã—ã¦ãã ã•ã„ã€‚