# [0.4] perf_diff - 基準比較ツール

**Labels**: `backlog`, `target-0.4`, `performance`, `enhancement`, `priority-p1`  
**Milestone**: `v0.4.0`  
**Priority**: P1 (高価値実装)

## 📋 目的
Git commit間やベースライン指定でのパフォーマンス変化を定量的に比較し、回帰検知と改善効果の可視化を行う。開発者が変更の性能影響を即座に把握できるツールを提供する。

## 🎯 具体的な仕様

### 基本的なCLI設計
```bash
# Git commit間の比較
python -m performance.tools.perf_diff --base v0.3.0 --head HEAD
python -m performance.tools.perf_diff --base abc1234 --head def5678

# ベースラインファイルとの比較  
python -m performance.tools.perf_diff --baseline results/baseline.json --current bench_results.json
python -m performance.tools.perf_diff --baseline results/v0.3.0_baseline.json

# 出力形式の指定
python -m performance.tools.perf_diff --base v0.3.0 --format json --output diff_report.json
python -m performance.tools.perf_diff --base v0.3.0 --format markdown --output diff_report.md
python -m performance.tools.perf_diff --base v0.3.0 --format console  # デフォルト
```

### 詳細コマンド仕様
```bash
# フルオプション例
python -m performance.tools.perf_diff \
  --base v0.3.0 \
  --head HEAD \
  --benchmark-suite core \
  --threshold 0.05 \
  --significance-level 0.95 \
  --include-memory \
  --output-dir reports/diff/ \
  --verbose
```

## 🔧 技術仕様

### 入力データ形式
```json
// 想定される bench_results.json 形式
{
  "metadata": {
    "timestamp": "2025-09-01T12:00:00Z",
    "commit_hash": "abc1234",
    "platform": "ubuntu-latest",
    "python_version": "3.11"
  },
  "benchmarks": {
    "pattern_compilation": {
      "p50_ms": 6.2,
      "p95_ms": 8.7,
      "mean_ms": 6.8,
      "std_ms": 1.2,
      "iterations": 1000
    },
    "rule_expansion": {
      "p50_ms": 12.4,
      "p95_ms": 15.8,
      "mean_ms": 13.1,
      "std_ms": 2.1,
      "iterations": 1000
    }
  }
}
```

### 出力レポート形式

#### Console出力
```
🔍 Performance Diff Report

📊 Summary
  Base:    v0.3.0 (abc1234)
  Current: HEAD   (def5678)
  
✅ Improvements (2)
  pattern_compilation: 6.8ms → 6.2ms (-8.8%, -0.6ms)
  rule_expansion:     13.1ms → 12.4ms (-5.3%, -0.7ms)

⚠️  Regressions (0)

📈 Detailed Analysis
┌─────────────────────┬──────────┬──────────┬──────────┬──────────┬──────────┐
│ Benchmark           │ Base P50 │ Curr P50 │ Diff %   │ Diff ms  │ Status   │
├─────────────────────┼──────────┼──────────┼──────────┼──────────┼──────────┤
│ pattern_compilation │   6.8ms  │   6.2ms  │  -8.8%   │  -0.6ms  │    ✅    │
│ rule_expansion      │  13.1ms  │  12.4ms  │  -5.3%   │  -0.7ms  │    ✅    │
└─────────────────────┴──────────┴──────────┴──────────┴──────────┴──────────┘

🎯 Statistical Significance
  Significance Level: 95%
  Significant Changes: 2/2 (100%)
```

#### JSON出力
```json
{
  "summary": {
    "base_ref": "v0.3.0",
    "current_ref": "HEAD", 
    "total_benchmarks": 2,
    "improvements": 2,
    "regressions": 0,
    "no_change": 0
  },
  "comparisons": [
    {
      "benchmark": "pattern_compilation",
      "base": {"p50_ms": 6.8, "p95_ms": 8.9},
      "current": {"p50_ms": 6.2, "p95_ms": 8.1},
      "diff": {
        "p50_percent": -8.8,
        "p50_absolute_ms": -0.6,
        "status": "improvement",
        "significance": 0.97
      }
    }
  ],
  "metadata": {
    "generated_at": "2025-09-01T12:30:00Z",
    "significance_level": 0.95,
    "threshold_percent": 5.0
  }
}
```

#### Markdown出力 (PR用)
```markdown
## 📊 Performance Diff Report

### Summary
- **Base**: v0.3.0 (abc1234)
- **Current**: HEAD (def5678)
- **Total Benchmarks**: 2
- **Improvements**: ✅ 2 | **Regressions**: ❌ 0 | **No Change**: ➖ 0

### Detailed Results

| Benchmark | Base P50 | Current P50 | Change | Status |
|-----------|----------|-------------|---------|---------|
| pattern_compilation | 6.8ms | 6.2ms | -8.8% (-0.6ms) | ✅ |
| rule_expansion | 13.1ms | 12.4ms | -5.3% (-0.7ms) | ✅ |

### Statistical Analysis
- **Significance Level**: 95%
- **Significant Changes**: 2/2 (100%)
- **Threshold**: ±5.0% for reporting

*Generated by perf_diff at 2025-09-01 12:30:00*
```

## ⚙️ 内部実装設計

### コアクラス構造
```python
# performance/tools/perf_diff.py
class PerformanceDiff:
    def __init__(self, significance_level=0.95, threshold_percent=5.0):
        self.significance_level = significance_level
        self.threshold_percent = threshold_percent
    
    def compare_commits(self, base_ref: str, current_ref: str) -> DiffResult:
        """Git commit間でのパフォーマンス比較"""
        
    def compare_files(self, baseline_file: str, current_file: str) -> DiffResult:
        """ベースラインファイルとの比較"""
        
    def run_benchmark_at_commit(self, commit_ref: str) -> BenchmarkResult:
        """指定commitでのベンチマーク実行"""
        
    def calculate_statistical_significance(self, base_data, current_data) -> float:
        """統計的有意性の計算 (t-test)"""

class DiffResult:
    def __init__(self):
        self.summary = DiffSummary()
        self.comparisons = List[BenchmarkComparison]
        self.metadata = DiffMetadata()
        
    def to_console(self) -> str:
        """コンソール表示用フォーマット"""
        
    def to_json(self) -> dict:
        """JSON出力用フォーマット"""
        
    def to_markdown(self) -> str:
        """マークダウン出力用フォーマット"""
```

### Git操作の統合
```python
# performance/utils/git_utils.py
class GitOperations:
    @staticmethod
    def checkout_and_run_benchmark(commit_ref: str) -> BenchmarkResult:
        """一時的にcommitをcheckoutしてベンチマーク実行"""
        current_branch = git.get_current_branch()
        try:
            git.checkout(commit_ref)
            result = perf_suite.run_benchmarks()
            return result
        finally:
            git.checkout(current_branch)
            
    @staticmethod
    def get_commit_info(commit_ref: str) -> CommitInfo:
        """コミット情報の取得"""
        return {
            "hash": git.rev_parse(commit_ref),
            "message": git.log_oneline(commit_ref),
            "timestamp": git.show_timestamp(commit_ref)
        }
```

## 📊 成功指標

### パフォーマンス要件
- **比較処理時間**: < 1秒 (ファイル間比較)
- **Git checkout + benchmark**: < 5分 (commit間比較)
- **差分検出精度**: > 95% (統計的有意性)
- **メモリ使用量**: < 50MB (大規模結果ファイル対応)

### 機能要件
- ✅ 複数ベンチマーク結果の一括比較
- ✅ 統計的有意性検定 (t-test)
- ✅ 閾値による報告フィルタリング
- ✅ 3種類の出力形式対応
- ✅ Git操作の安全性確保 (元ブランチ復帰)

### ユーザビリティ要件  
- ✅ 直感的なCLIインターフェース
- ✅ カラー表示による視認性向上
- ✅ エラー時の適切なメッセージ表示
- ✅ 進捗表示 (長時間処理時)

## 🔗 使用例・ワークフロー統合

### 開発者の日常ワークフロー
```bash
# 1. 機能開発後の性能影響確認
git commit -m "Optimize pattern compilation"
python -m performance.tools.perf_diff --base HEAD~1 --head HEAD

# 2. PRマージ前の最終確認
python -m performance.tools.perf_diff --base main --head feature/optimization \
  --format markdown --output pr_perf_report.md

# 3. リリース前の総合確認
python -m performance.tools.perf_diff --base v0.3.0 --head release/0.4.0 \
  --include-memory --significance-level 0.99
```

### CI統合案
```yaml
# .github/workflows/performance-diff.yml
- name: Performance Regression Check
  run: |
    python -m performance.tools.perf_diff \
      --base ${{ github.event.pull_request.base.sha }} \
      --head ${{ github.sha }} \
      --threshold 10.0 \
      --format json \
      --output pr_diff.json
      
- name: Comment PR with Diff
  uses: actions/github-script@v6
  with:
    script: |
      const diffData = JSON.parse(fs.readFileSync('pr_diff.json'));
      if (diffData.summary.regressions > 0) {
        github.rest.issues.createComment({
          issue_number: context.issue.number,
          owner: context.repo.owner,
          repo: context.repo.repo,
          body: `⚠️ Performance regression detected!\n\n${diffData.markdown}`
        });
      }
```

## 🚫 非目標・制限事項

### 現在のスコープ外
- **複数ブランチ同時比較**: 2-way比較のみ
- **リアルタイム監視**: バッチ処理のみ
- **自動ベースライン更新**: 手動管理
- **視覚化グラフ**: テキストベース出力のみ
- **メモリプロファイル詳細**: 基本統計のみ

### 制限事項
- **Git操作**: 作業ディレクトリがクリーンである前提
- **ベンチマーク環境**: 一貫性のある実行環境必要
- **統計精度**: 最低3回の実行結果が必要
- **大規模データ**: 100MB超のファイルは未対応

## 🔄 実装戦略

### Phase 1: 基本機能 (Week 1-2)
1. `DiffResult`クラス設計・実装
2. ファイル間比較機能 (`compare_files`)
3. 基本的なCLI設計・実装
4. Console/JSON出力フォーマット

### Phase 2: Git統合 (Week 2-3)
1. `GitOperations`クラス実装
2. Commit間比較機能 (`compare_commits`)
3. 安全なcheckout/復帰機能
4. エラーハンドリング強化

### Phase 3: 統計・高度機能 (Week 3-4)
1. 統計的有意性検定実装
2. 閾値フィルタリング機能
3. Markdown出力フォーマット
4. パフォーマンス最適化

### Phase 4: 統合・検証 (Week 4)
1. CI統合テスト
2. 大規模データでの動作確認
3. ドキュメント・使用例整備
4. エラーケース対応完了

## 🔗 関連・依存 Issues

### 前提条件
- ✅ Performance Tools MVP (0.3.0) - `perf_suite`の安定動作
- ✅ `bench_results.json`形式の標準化
- ✅ Git操作の基盤整備

### 連携推奨
- **CI完全統合** (P0) - PR comment自動生成での活用
- **perf_analyze** (P2) - 回帰原因の詳細分析連携
- **Performance ドキュメント** (P2) - 使用例・ベストプラクティス

### 後続展開  
- **perf_trend** (0.5.0) - 長期トレンド分析
- **perf_bisect** (0.5.0) - 回帰導入commit特定
- **perf_dashboard** (0.5.0) - Web UI統合

## ✅ 完了条件 (Definition of Done)

### 技術要件
- [ ] ファイル間比較機能動作確認
- [ ] Git commit間比較機能動作確認
- [ ] 3種類出力形式の品質確認
- [ ] 統計的有意性検定の精度検証
- [ ] エラー時の適切な復旧確認

### 品質要件
- [ ] 単体テスト Coverage > 90%
- [ ] 統合テスト (実際のリポジトリでの動作)
- [ ] パフォーマンステスト (大規模データ)
- [ ] ユーザビリティテスト (CLI操作性)

### ドキュメント要件
- [ ] API仕様書作成
- [ ] 使用例・ベストプラクティス整備
- [ ] トラブルシューティングガイド
- [ ] CI統合手順書

### 検証要件
- [ ] 既知の性能改善・回帰での動作確認
- [ ] 複数環境での一貫性確認
- [ ] 統計精度の実証データ取得

---

**推定工数**: 3-4 weeks  
**担当者**: TBD  
**レビュワー**: Performance Engineering Team  
**作成日**: 2025-09-01  
**最終更新**: 2025-09-01